<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bookshelf – Arun Baburaj</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #dbe2eb;
      --text: #111219;
      --muted: #5b6066;
      --max-width: 720px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background:var(--bg);
      color:var(--text);
    }

    /* top thin border like reference */
    .page-top-border{height:3px;background:rgba(0,0,0,0.08);}

    header{
      display:flex;
      justify-content:center;
      border-bottom:1px solid rgba(0,0,0,0.06);
      background:transparent;
      width:100%;
      position:relative;
      z-index:40;
    }

    /* NAV (matches the other pages exactly) */
    .nav{
      max-width:var(--max-width);
      width:100%;
      display:flex;
      justify-content:flex-start;
      padding:20px 16px;
      gap:28px;
      font-size:15px;
      font-weight:600;
      color:var(--muted);
      margin:0 auto;
    }
    .nav a{color:var(--muted);text-decoration:none;padding-bottom:4px;border-bottom:2px solid transparent}
    .nav a:hover{border-bottom-color:var(--text);color:var(--text)}
    .nav a.active{color:var(--text);border-bottom-color:var(--text)}

    /* page container */
    .container{max-width:var(--max-width);margin:40px auto;padding:0 20px}
    .page-title{font-size:22px;font-weight:700;margin:8px 0 12px}

    /* Book card (bigger covers) */
    .book-item{display:flex;gap:14px;align-items:center;padding:12px;border-radius:8px;background:rgba(255,255,255,0.04);border:1px solid rgba(0,0,0,0.04)}
    .book-cover{width:120px;height:180px;object-fit:cover;border-radius:6px;background:#eceff4;flex-shrink:0}
    .book-meta{display:flex;flex-direction:column}
    .book-title{font-weight:700;margin-bottom:6px;font-size:16px}
    .book-author{color:var(--muted);font-size:14px}
    .book-count{margin-top:12px;color:var(--muted);font-size:13px}

    /* MARQUEE: horizontal scroller with 3 rows */
    .marquee { overflow: hidden; width:100%; margin-top:12px; }
    .marquee-viewport { position:relative; width:100%; }
    .marquee-track {
      display:grid;
      grid-auto-flow:column;
      grid-auto-columns: 260px; /* card width + gap approximation */
      grid-template-rows: repeat(3, auto);
      gap:20px;
      align-items:start;
      transform: translateX(0);
    }
    .marquee-anim { display:block; will-change:transform; }

    /* small screens adjustments */
    @media (max-width:900px){
      .marquee-track{grid-auto-columns:220px}
      .book-cover{width:100px;height:150px}
    }
    @media (max-width:700px){
      .marquee-track{grid-auto-columns:180px}
      .book-cover{width:90px;height:135px}
    }

    /* ensure header visible above marquee */
    header, .page-top-border { position:relative; z-index:50; }
  </style>
</head>
<body>
  <div class="page-top-border"></div>

  <!-- Header + nav (must match other pages) -->
  <header>
    <nav class="nav" aria-label="Main navigation">
      <a href="/" >Index</a>
      <a href="/portfolio" >Portfolio</a>
      <a href="/bookshelf" class="active">Bookshelf</a>
      <a href="/principles" >Principles</a>
    </nav>
  </header>

  <div class="container">
    <div class="page-title">Bookshelf</div>

    <!-- marquee container: inner content will be duplicated for seamless loop -->
    <div id="book-marquee" class="marquee" aria-hidden="false">
      <div class="marquee-viewport">
        <div id="marquee-anim" class="marquee-anim">
          <div id="marquee-track" class="marquee-track">
            <!-- items injected here -->
          </div>
        </div>
      </div>
    </div>

    <div id="book-count" class="book-count" aria-live="polite"></div>
  </div>

  <script>
  /************************************************************************
   * Bookshelf page script
   * - For canvas preview this file uses the sandbox CSV path uploaded by you:
   *   /mnt/data/Books Tracker - Sheet2.csv
   * - For production, replace CSV_CANDIDATES with ['/data/books.csv','/books.csv']
   ************************************************************************/

  // **SANDBOX PATH** (this is the file you uploaded in this session)
  const CSV_CANDIDATES = [
    '/mnt/data/Books Tracker - Sheet2.csv'
  ];

  // Robust CSV parser (supports quoted fields & CRLF)
  function parseCSV(text){
    const rows = [];
    let cur = '', row = [], inQuotes = false;
    for(let i=0;i<text.length;i++){
      const ch = text[i], nxt = text[i+1];
      if(ch === '"'){
        if(inQuotes && nxt === '"'){ cur += '"'; i++; continue; } // escaped quote
        inQuotes = !inQuotes;
        continue;
      }
      if(ch === ',' && !inQuotes){ row.push(cur); cur = ''; continue; }
      if((ch === '\n' || ch === '\r') && !inQuotes){
        if(ch === '\r' && text[i+1] === '\n') i++;
        row.push(cur); rows.push(row); row = []; cur = ''; continue;
      }
      cur += ch;
    }
    if(cur !== '' || row.length) { row.push(cur); rows.push(row); }
    if(rows.length && rows[rows.length-1].length === 1 && rows[rows.length-1][0] === '') rows.pop();
    return rows;
  }

  function normalizeHeader(h){ return String(h||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'_'); }
  function sanitizeIsbn(s){ if(!s) return ''; s = String(s).trim().replace(/[^0-9Xx]/g,''); if(!s || s.toLowerCase() === 'nan') return ''; return s; }

  // Create a card DOM node for a book
  function createBookCard(item){
    const title = item.title || item.book || item.name || 'Untitled';
    const author = item.author || item.authors || '';
    const isbn = sanitizeIsbn(item.isbn || item.isbn13 || item.isbn10 || '');
    const cover = isbn ? `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg` : '';

    const card = document.createElement('div');
    card.className = 'book-item';

    const img = document.createElement('img');
    img.className = 'book-cover';
    img.alt = title + ' cover';
    if(cover){
      img.src = cover;
      img.onerror = () => { img.src=''; img.style.background='#e9edf3'; img.alt='No cover'; };
    }

    const meta = document.createElement('div');
    meta.className = 'book-meta';
    const t = document.createElement('div'); t.className = 'book-title'; t.textContent = title;
    const a = document.createElement('div'); a.className = 'book-author'; a.textContent = author;

    meta.appendChild(t);
    if(author) meta.appendChild(a);

    card.appendChild(img);
    card.appendChild(meta);
    return card;
  }

  // Load CSV from candidate URLs (in order)
  async function loadCsvCandidates(){
    for(const url of CSV_CANDIDATES){
      try{
        const res = await fetch(url, {cache: 'no-store'});
        if(!res.ok){ console.warn('CSV not found at', url, res.status); continue; }
        const txt = await res.text();
        const rows = parseCSV(txt);
        if(!rows || rows.length < 1) continue;
        const headers = rows[0].map(normalizeHeader);
        const objs = [];
        for(let r = 1; r < rows.length; r++){
          const row = rows[r];
          if(row.every(c => String(c||'').trim() === '')) continue;
          const obj = {};
          for(let c = 0; c < headers.length; c++){
            obj[headers[c]] = row[c] !== undefined ? row[c].trim() : '';
          }
          objs.push(obj);
        }
        return objs;
      }catch(err){
        console.warn('Failed to fetch/parse CSV', url, err);
        continue;
      }
    }
    return null;
  }

  // Render marquee track and start continuous scroll
  function renderMarquee(items){
    const track = document.getElementById('marquee-track');
    track.innerHTML = '';

    // Insert all items
    items.forEach(it => track.appendChild(createBookCard(it)));

    // Duplicate content for seamless scroll
    track.innerHTML += track.innerHTML;

    // Compute animation distance and start animation
    requestAnimationFrame(() => {
      const totalWidth = track.scrollWidth;
      const halfWidth = totalWidth / 2;
      const speed = 80; // pixels per second baseline
      const duration = Math.max(8, Math.round(halfWidth / speed)); // seconds

      // remove any existing dynamic keyframes
      const styleId = 'marquee-keyframes';
      let s = document.getElementById(styleId);
      if(s) s.remove();

      // insert dynamic keyframes to shift by halfWidth
      s = document.createElement('style'); s.id = styleId;
      s.innerHTML = `@keyframes scrollLeft { from { transform: translateX(0); } to { transform: translateX(-${halfWidth}px); } }`;
      document.head.appendChild(s);

      const animWrap = document.getElementById('marquee-anim');
      animWrap.style.animation = `scrollLeft ${duration}s linear infinite`;
    });
  }

  // Initialize
  (async function init(){
    const countEl = document.getElementById('book-count');
    const data = await loadCsvCandidates();
    if(!data){
      document.getElementById('marquee-track').innerHTML = '<div style="padding:12px;color:var(--muted)">No books found — upload <code>/data/books.csv</code> to your repo.</div>';
      return;
    }
    const mapped = data.map(row => ({
      title: row.title || row.book || row.name || '',
      author: row.author || row.authors || '',
      isbn: row.isbn || row.isbn13 || row.isbn10 || ''
    }));
    if(mapped.length === 0){
      document.getElementById('marquee-track').innerHTML = '<div style="padding:12px;color:var(--muted)">No books available.</div>';
      return;
    }

    renderMarquee(mapped);
    countEl.textContent = `${mapped.length} book${mapped.length > 1 ? 's' : ''}`;
  })();
  </script>
</body>
</html>
